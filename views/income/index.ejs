<div id="app">
    <header>
        <nav class="navbar navbar-default">
            <div class="container">
                <div class="navbar-header">
                    <h3 class="title">
                        <%= title %>
                    </h3>
                </div>
                <div class="navbar-text navbar-right">
                    <form class="form-inline" method="GET" id="search-form">
                        <span>劇場</span>&nbsp;
                        <select name="theaterCd" class="form-control" v-model="theaterCd" @change="updateScreeningWork()">
                            <option value="" disabled selected>選択してください</option>
                            <% for (const theater of theaters) { %>
                                <option value="<%= theater.theaterCd %>"><%= theater.theaterName %></option>
                            <% } %>
                        </select>
                        <span class="separator"></span>
                        <select name="year" class="form-control" v-model="date.year" @change="updateScreeningWork()">
                            <option value="0" disabled selected>--</option>
                            <option v-for="year in _.range(2000, 2020)" :value="year">{{ year }}</option>
                        </select>
                        <span>年</span>&nbsp;
                        <select name="month" class="form-control" v-model="date.month" @change="updateScreeningWork()">
                            <option value="0" disabled selected>--</option>
                            <option v-for="month in 12" :value="padZero(month)">{{ padZero(month) }}</option>
                        </select>
                        <span>月</span>&nbsp;
                        <select name="date" class="form-control" v-model="date.date" @change="updateScreeningWork()">
                            <option value="0" disabled selected>--</option>
                            <option v-for="date in calculateDate(date.year, date.month)" :value="date">{{ date }}</option>
                        </select>
                        <span>日</span>&nbsp;
                        <button class="btn btn-primary" type="button" @click="search">検索</button>
                    </form>
                </div>
            </div>
        </nav>
    </header>

    <div class="container" v-if="incomes.length > 0">
        <div class="row" v-if="incomes.length > 0">
            <div class="col-xs-12 info-container">
                <div class="additional-info">
                    <span>
                        <b>劇場：</b>{{ incomes[0].theaterName }}
                    </span>
                    <span>
                        <b>日付：</b>{{ incomes[0].date.slice(0, 10) }}
                    </span>
                </div>
            </div>
        </div>
        <div class="row" style="margin-bottom: 120px">
            <div class="col-xs-12 data-table">
                <div class="table-responsive table-bordered">
                    <table class="table">
                        <thead>
                            <tr>
                                <th></th>
                                <th style="width: 70px">細目</th>
                                <th>科目分類</th>
                                <th>科目</th>
                                <th>細目</th>
                                <th style="width: 100px">数量</th>
                                <th style="width: 100px">金額</th>
                                <th>相手科目</th>
                                <th>備考</th>
                                <th>作品</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(income, index) in incomes" :class="{ error: income.isValid === false }" v-model="income.isValid">
                                <td><button class="btn btn-danger" @click="deleteRow(index)">削除</button></td>
                                <td>
                                    <input
                                        type="text"
                                        v-model="income.subjectDetailCd"
                                        class="form-control"
                                        :name="`subjectDetailCd${index}`"
                                        @change="searchSubjectDetailByCode(income.subjectDetailCd, index)"
                                    >
                                </td>
                                <td>
                                    <select
                                        :name="`subjectGroupCd${index}`"
                                        v-model="income.subjectGroupCd"
                                        class="form-control"
                                        @change="resetSubject(true, true, index)"
                                    >
                                        <option value="0" disabled selected>--</option>
                                        <option
                                            :value="subjectGroup.subjectGroupCd"
                                            v-for="subjectGroup in subjectGroups"
                                        >
                                        {{ subjectGroup.subjectGroupName }}
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <select
                                        :name="`subjectCd${index}`"
                                        v-model="income.subjectCd"
                                        class="form-control"
                                        @change="resetSubject(false, true, index)"
                                    >
                                        <option value="0" disabled selected>--</option>
                                        <option
                                            :value="subject.subjectCd"
                                            v-for="subject in generateSubjects(income.subjectGroupCd, index)"
                                        >
                                        {{ subject.subjectName }}
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <select
                                        :name="`subjectDetail${index}`"
                                        v-model="income.subjectDetailCd"
                                        class="form-control"
                                    >
                                        <option value="0" disabled selected>--</option>
                                        <option
                                            :value="subjectDetail.subjectDetailCd"
                                            v-for="subjectDetail in generateSubjectDetails(income.subjectCd, index)"
                                        >
                                        {{ subjectDetail.subjectDetailName }}
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <input
                                        type="text"
                                        v-model="income.quantity"
                                        class="form-control"
                                        :name="`quantity${index}`"
                                    >
                                </td>
                                <td>
                                    <input
                                        type="text"
                                        v-model="income.amount"
                                        class="form-control"
                                        :name="`amount${index}`"
                                    >
                                </td>
                                <td>
                                    <select :name="`opponentSubjectCd${index}`" v-model="income.opponentSubjectCd" class="form-control">
                                        <option value="0" disabled selected>--</option>
                                        <option
                                            :value="subject.subjectDetailCd"
                                            v-for="subject in opponentSubjects"
                                        >
                                        {{ subject.subjectDetailName }}
                                        </option>
                                    </select>
                                </td>
                                <td><input :name="`note${index}`" type="text" v-model="income.note" class="form-control"></td>
                                <td>
                                    <select :name="`movieCd${index}`" v-model="income.movieCd" class="form-control">
                                        <option value="0" disabled selected>--</option>
                                        <option
                                            :value="screeningWork.screeningWorkId"
                                            v-for="screeningWork in screeningWorks"
                                        >
                                        {{ screeningWork.screeningWorkName }}
                                        </option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="action-btn" v-if="theaterCd !== ''">
        <span class="add-btn" @click="addRow">
            +
        </span>
        <br>
        <button class="btn btn-primary btn-lg" style="width: 200px" v-if="incomes.length > 0" @click="submit">
            反映
        </button>
    </div>
</div>
<%- contentFor('scripts') %>
<script>
    var accountData = <%- JSON.stringify(accounts) %>;
    var incomeData = <%- JSON.stringify(incomes) %>;
    var query = <%- JSON.stringify(req.query) %>;
</script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
<script src="/js/master/income.js"></script>